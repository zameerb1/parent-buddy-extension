<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Buddy - Live Tabs</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    h1 { font-size: 24px; color: #4ade80; }
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #888;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .device {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .device-name {
      font-size: 18px;
      font-weight: 600;
      color: #60a5fa;
    }
    .device-time {
      font-size: 12px;
      color: #666;
    }
    .tabs-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tab-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #0f172a;
      padding: 12px 16px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .tab-item:hover {
      background: #1e293b;
    }
    .tab-favicon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: #333;
      flex-shrink: 0;
    }
    .tab-info {
      flex: 1;
      min-width: 0;
    }
    .tab-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .tab-url {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tab-active {
      border-left: 3px solid #4ade80;
    }
    .youtube-tab {
      border-left: 3px solid #ff0000;
    }
    .no-tabs {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .tab-count {
      background: #4ade80;
      color: #000;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .refresh-btn {
      background: #4ade80;
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .refresh-btn:hover {
      background: #22c55e;
    }
    .block-btn {
      background: #f59e0b;
      color: #000;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .block-btn:hover {
      background: #d97706;
    }
    .ban-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .ban-btn:hover {
      background: #dc2626;
    }
    .tab-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    .blocked-list, .banned-list {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .blocked-list h2 {
      font-size: 16px;
      color: #f59e0b;
      margin-bottom: 15px;
    }
    .banned-list h2 {
      font-size: 16px;
      color: #ef4444;
      margin-bottom: 15px;
    }
    .lists-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 800px) {
      .lists-container {
        grid-template-columns: 1fr;
      }
    }
    .connection-status {
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .connection-ok {
      background: #16a34a22;
      border: 1px solid #16a34a;
      color: #4ade80;
    }
    .connection-warning {
      background: #f59e0b22;
      border: 1px solid #f59e0b;
      color: #fbbf24;
    }
    .connection-error {
      background: #ef444422;
      border: 1px solid #ef4444;
      color: #f87171;
    }
    .blocked-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0f172a;
      padding: 10px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .unblock-btn {
      background: #22c55e;
      color: #000;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }
    .unblock-btn:hover {
      background: #16a34a;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4ade80;
      color: #000;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      display: none;
      z-index: 1000;
    }
    .toast.error {
      background: #ef4444;
      color: #fff;
    }
    .toast.show {
      display: block;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .internet-control {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .control-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
    }
    .control-icon {
      font-size: 24px;
    }
    .control-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .enable-btn {
      background: #22c55e;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .enable-btn:hover {
      background: #16a34a;
    }
    .disable-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .disable-btn:hover {
      background: #dc2626;
    }
    .time-remaining {
      margin-top: 10px;
      font-size: 14px;
      color: #888;
    }
    .internet-on {
      color: #4ade80;
    }
    .internet-off {
      color: #ef4444;
    }
    .device-select {
      background: #0f172a;
      color: #fff;
      border: 1px solid #333;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .device-select:focus {
      outline: none;
      border-color: #4ade80;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Parent Buddy - Live Tabs</h1>
    <div class="status">
      <div class="status-dot"></div>
      <span>Auto-refreshing every 5s</span>
      <button class="refresh-btn" onclick="fetchTabs()">Refresh Now</button>
    </div>
  </div>

  <div id="internet-control" class="internet-control">
    <div class="control-row">
      <div class="control-label">
        <select id="device-select" class="device-select" onchange="fetchInternetStatus()">
          <option value="">Select device...</option>
        </select>
        <span class="control-icon" id="internet-icon">üåê</span>
        <span id="internet-status-text">Internet: --</span>
      </div>
      <div class="control-buttons">
        <button class="enable-btn" onclick="enableInternet(15)">15 min</button>
        <button class="enable-btn" onclick="enableInternet(30)">30 min</button>
        <button class="enable-btn" onclick="enableInternet(60)">1 hour</button>
        <button class="enable-btn" onclick="enableInternet(null)">Unlimited</button>
        <button class="disable-btn" onclick="disableInternet()">Block All</button>
      </div>
    </div>
    <div id="time-remaining" class="time-remaining"></div>
  </div>

  <div id="connection-status" class="connection-status connection-warning">
    Waiting for Chromebook to connect...
  </div>

  <div class="lists-container">
    <div id="blocked-container"></div>
    <div id="banned-container"></div>
  </div>

  <div id="devices-container">
    <div class="no-tabs">Waiting for data from Chromebook...</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const container = document.getElementById('devices-container');
    const blockedContainer = document.getElementById('blocked-container');
    const bannedContainer = document.getElementById('banned-container');
    const connectionStatus = document.getElementById('connection-status');
    const toast = document.getElementById('toast');

    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 3000);
    }

    function formatTime(timestamp) {
      if (!timestamp) return 'Never';
      const date = new Date(timestamp);
      return date.toLocaleTimeString();
    }

    function formatTimeAgo(timestamp) {
      if (!timestamp) return 'Never';
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 10) return 'Just now';
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }

    function updateConnectionStatus(devices) {
      if (!devices || devices.length === 0) {
        connectionStatus.className = 'connection-status connection-warning';
        connectionStatus.textContent = '‚ö†Ô∏è No devices connected. Waiting for Chromebook...';
        return;
      }

      const device = devices[0]; // First device
      const lastPing = device.lastUpdate;
      const secondsAgo = Math.floor((Date.now() - lastPing) / 1000);

      if (secondsAgo < 10) {
        connectionStatus.className = 'connection-status connection-ok';
        connectionStatus.textContent = `‚úÖ ${device.deviceId} connected - Last ping: ${formatTimeAgo(lastPing)}`;
      } else if (secondsAgo < 30) {
        connectionStatus.className = 'connection-status connection-warning';
        connectionStatus.textContent = `‚ö†Ô∏è ${device.deviceId} - Last ping: ${formatTimeAgo(lastPing)}`;
      } else {
        connectionStatus.className = 'connection-status connection-error';
        connectionStatus.textContent = `‚ùå ${device.deviceId} NOT responding - Last ping: ${formatTimeAgo(lastPing)}`;
      }
    }

    function getFaviconUrl(url) {
      try {
        const u = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=32`;
      } catch {
        return '';
      }
    }

    function isYouTube(url) {
      return url && (url.includes('youtube.com') || url.includes('youtu.be'));
    }

    function getDomain(url) {
      try {
        return new URL(url).hostname;
      } catch {
        return url;
      }
    }

    // === BLOCK (temporary) ===
    async function blockTab(url, title) {
      try {
        const res = await fetch('/api/tabs/block', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, title })
        });
        if (res.ok) {
          showToast(`Blocked: ${getDomain(url)}`);
          fetchBlocked();
        }
      } catch (e) {
        showToast('Error blocking', true);
      }
    }

    async function unblockUrl(url) {
      try {
        const res = await fetch('/api/tabs/unblock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (res.ok) {
          showToast(`Unblocked: ${getDomain(url)}`);
          fetchBlocked();
        }
      } catch (e) {
        showToast('Error unblocking', true);
      }
    }

    // === BAN (permanent) ===
    async function banTab(url, title) {
      try {
        const res = await fetch('/api/tabs/ban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, title })
        });
        if (res.ok) {
          showToast(`Banned: ${getDomain(url)}`);
          fetchBanned();
          fetchBlocked();
        }
      } catch (e) {
        showToast('Error banning', true);
      }
    }

    async function unbanUrl(url) {
      try {
        const res = await fetch('/api/tabs/unban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (res.ok) {
          showToast(`Unbanned: ${getDomain(url)}`);
          fetchBanned();
        }
      } catch (e) {
        showToast('Error unbanning', true);
      }
    }

    function renderBlocked(data) {
      const blocked = data.blocked || [];
      if (blocked.length === 0) {
        blockedContainer.innerHTML = `
          <div class="blocked-list">
            <h2>‚è∏Ô∏è Blocked (Temporary)</h2>
            <div class="blocked-item" style="color:#666">No sites blocked. Clears when internet is re-enabled.</div>
          </div>
        `;
        return;
      }

      blockedContainer.innerHTML = `
        <div class="blocked-list">
          <h2>‚è∏Ô∏è Blocked (${blocked.length}) - Temporary</h2>
          ${blocked.map(item => `
            <div class="blocked-item">
              <span>${item.domain || getDomain(item.url)}</span>
              <button class="unblock-btn" onclick="unblockUrl('${item.url.replace(/'/g, "\\'")}')">Allow</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderBanned(data) {
      const banned = data.banned || [];
      if (banned.length === 0) {
        bannedContainer.innerHTML = `
          <div class="banned-list">
            <h2>üö´ Banned (Permanent)</h2>
            <div class="blocked-item" style="color:#666">No sites banned. Banned sites are always blocked.</div>
          </div>
        `;
        return;
      }

      bannedContainer.innerHTML = `
        <div class="banned-list">
          <h2>üö´ Banned (${banned.length}) - Permanent</h2>
          ${banned.map(item => `
            <div class="blocked-item">
              <span>${item.domain || getDomain(item.url)}</span>
              <button class="unblock-btn" onclick="unbanUrl('${item.url.replace(/'/g, "\\'")}')">Unban</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderDevices(data) {
      if (!data.devices || data.devices.length === 0) {
        container.innerHTML = '<div class="no-tabs">No devices connected. Install the extension on the Chromebook.</div>';
        return;
      }

      container.innerHTML = data.devices.map(device => {
        const tabs = device.tabs || [];
        return `
          <div class="device">
            <div class="device-header">
              <div class="device-name">${device.deviceId}</div>
              <div>
                <span class="tab-count">${tabs.length} tabs</span>
                <span class="device-time">Updated: ${formatTime(device.lastUpdate)}</span>
              </div>
            </div>
            <div class="tabs-list">
              ${tabs.length === 0 ? '<div class="no-tabs">No tabs open</div>' : tabs.map(tab => `
                <div class="tab-item ${tab.active ? 'tab-active' : ''} ${isYouTube(tab.url) ? 'youtube-tab' : ''}">
                  <img class="tab-favicon" src="${getFaviconUrl(tab.url)}" onerror="this.style.display='none'">
                  <div class="tab-info">
                    <div class="tab-title">${tab.title || 'Untitled'}</div>
                    <div class="tab-url">${tab.url || ''}</div>
                  </div>
                  <div class="tab-actions">
                    <button class="block-btn" onclick="blockTab('${tab.url.replace(/'/g, "\\'")}', '${(tab.title || '').replace(/'/g, "\\'")}')">Block</button>
                    <button class="ban-btn" onclick="banTab('${tab.url.replace(/'/g, "\\'")}', '${(tab.title || '').replace(/'/g, "\\'")}')">Ban</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    async function fetchTabs() {
      try {
        const res = await fetch('/api/tabs');
        const data = await res.json();
        renderDevices(data);
        updateDeviceDropdown(data.devices || []);
        updateConnectionStatus(data.devices || []);
      } catch (e) {
        console.error('Failed to fetch tabs:', e);
      }
    }

    async function fetchBlocked() {
      try {
        const res = await fetch('/api/tabs/blocked');
        const data = await res.json();
        renderBlocked(data);
      } catch (e) {
        console.error('Failed to fetch blocked:', e);
      }
    }

    async function fetchBanned() {
      try {
        const res = await fetch('/api/tabs/banned');
        const data = await res.json();
        renderBanned(data);
      } catch (e) {
        console.error('Failed to fetch banned:', e);
      }
    }

    // Get selected device
    function getSelectedDevice() {
      return document.getElementById('device-select').value;
    }

    // Update device dropdown
    function updateDeviceDropdown(devices) {
      const select = document.getElementById('device-select');
      const current = select.value;

      // Keep existing selection if still valid
      const deviceIds = devices.map(d => d.deviceId);

      // Clear and repopulate
      select.innerHTML = '<option value="">Select device...</option>';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.deviceId;
        select.appendChild(opt);
      });

      // Restore selection or auto-select if only one device
      if (deviceIds.includes(current)) {
        select.value = current;
      } else if (devices.length === 1) {
        select.value = devices[0].deviceId;
        fetchInternetStatus();
      }
    }

    // Internet control functions
    async function enableInternet(minutes) {
      const deviceId = getSelectedDevice();
      if (!deviceId) {
        showToast('Select a device first', true);
        return;
      }
      try {
        const res = await fetch('/api/internet/enable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceId, minutes })
        });
        if (res.ok) {
          const msg = minutes ? `Internet enabled for ${minutes} minutes` : 'Internet enabled (unlimited)';
          showToast(msg);
          fetchInternetStatus();
        }
      } catch (e) {
        showToast('Error enabling internet', true);
      }
    }

    async function disableInternet() {
      const deviceId = getSelectedDevice();
      if (!deviceId) {
        showToast('Select a device first', true);
        return;
      }
      try {
        const res = await fetch('/api/internet/disable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceId })
        });
        if (res.ok) {
          showToast('Internet disabled');
          fetchInternetStatus();
        }
      } catch (e) {
        showToast('Error disabling internet', true);
      }
    }

    async function fetchInternetStatus() {
      const deviceId = getSelectedDevice();
      if (!deviceId) return;

      try {
        const res = await fetch(`/api/internet/status?deviceId=${encodeURIComponent(deviceId)}`);
        const data = await res.json();

        const statusText = document.getElementById('internet-status-text');
        const icon = document.getElementById('internet-icon');
        const timeRemaining = document.getElementById('time-remaining');

        if (data.internetAllowed) {
          statusText.textContent = 'Internet: ON';
          statusText.className = 'internet-on';
          icon.textContent = 'üü¢';

          if (data.expiresAt) {
            const remaining = Math.max(0, Math.floor((data.expiresAt - Date.now()) / 60000));
            timeRemaining.textContent = `Time remaining: ${remaining} minutes`;
          } else {
            timeRemaining.textContent = 'Unlimited access';
          }
        } else {
          statusText.textContent = 'Internet: OFF';
          statusText.className = 'internet-off';
          icon.textContent = 'üî¥';
          timeRemaining.textContent = '';
        }
      } catch (e) {
        console.error('Failed to fetch internet status:', e);
      }
    }

    // Initial fetch
    fetchTabs();
    fetchBlocked();
    fetchBanned();
    fetchInternetStatus();

    // Auto-refresh
    setInterval(fetchTabs, 3000);
    setInterval(fetchBlocked, 5000);
    setInterval(fetchBanned, 10000);
    setInterval(fetchInternetStatus, 5000);
  </script>
</body>
</html>
